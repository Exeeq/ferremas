{% extends 'core/base.html' %}
{% load static %}
{% block contenido %}

		<!-- Start Hero Section -->
			<div class="hero">
				<div class="container">
					<div class="row justify-content-between">
						<div class="col-lg-5">
							<div class="intro-excerpt">
								<h1>Checkout</h1>
							</div>
						</div>
						<div class="col-lg-7">
							
						</div>
					</div>
				</div>
			</div>
		<!-- End Hero Section -->

		<div class="untree_co-section">
		    <div class="container">
		      <div class="row">
		        <div class="col-md-6 mb-5 mb-md-0">
		          <h2 class="h3 mb-3 text-black">Detalle del pedido</h2>
		          <div class="p-3 p-lg-5 border bg-white">

		            <div class="form-group row">
		              <div class="col-md-6">
		                <label for="c_fname" class="text-black">Nombre <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_fname" name="c_fname">
		              </div>
		              <div class="col-md-6">
		                <label for="c_lname" class="text-black">Apellido <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_lname" name="c_lname">
		              </div>
		            </div>

		            <div class="form-group row">
		              <div class="col-md-12">
		                <label for="c_companyname" class="text-black">Run </label>
		                <input type="text" class="form-control" id="c_companyname" name="c_companyname">
		              </div>
		            </div>

		            <div class="form-group row">
		              <div class="col-md-12">
		                <label for="c_address" class="text-black">Dirección <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_address" name="c_address" placeholder="Calle">
		              </div>
		            </div>

		            <div class="form-group row">
		              <div class="col-md-6">
		                <label for="c_state_country" class="text-black">Región <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_state_country" name="c_state_country">
		              </div>
		              <div class="col-md-6">
		                <label for="c_postal_zip" class="text-black">Comuna <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_postal_zip" name="c_postal_zip">
		              </div>
		            </div>

		            <div class="form-group row mb-5">
		              <div class="col-md-6">
		                <label for="c_email_address" class="text-black">Correo electrónico <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_email_address" name="c_email_address">
		              </div>
		              <div class="col-md-6">
		                <label for="c_phone" class="text-black">Celular <span class="text-danger">*</span></label>
		                <input type="text" class="form-control" id="c_phone" name="c_phone" placeholder="">
		              </div>
		            </div>

		          </div>
		        </div>
		        <div class="col-md-6">

		          <div class="row mb-5">
		            <div class="col-md-12">
		              <h2 class="h3 mb-3 text-black">Cupón de descuento</h2>
		              <div class="p-3 p-lg-5 border bg-white">

		                <label for="c_code" class="text-black mb-3">Ingrese su cupón, si tiene uno.</label>
		                <div class="input-group w-75 couponcode-wrap">
		                  <input type="text" class="form-control me-2" id="c_code" placeholder="Cupón" aria-label="Coupon Code" aria-describedby="button-addon2">
		                  <div class="input-group-append">
		                    <button class="btn btn-black btn-sm" type="button" id="button-addon2">Aplicar cupón</button>
		                  </div>
		                </div>

		              </div>
		            </div>
		          </div>

		          <div class="row mb-5">
					<div class="col-md-12">
						<h2 class="h3 mb-3 text-black">Tu pedido</h2>
						<div class="p-3 p-lg-5 border bg-white">
							<table class="table site-block-order-table mb-5">
								<thead>
									<th>Producto</th>
									<th>Total</th>
								</thead>
								<tbody>
									{% for item in items %}
									<tr>
										<td>{{ item.producto.nombreProducto }} <strong class="mx-2">x</strong> {{ item.cantidad }}</td>
										<td>${{ item.precio_total }}</td>
									</tr>
									{% endfor %}
									<tr>
										<td class="text-black font-weight-bold"><strong>Subtotal carrito</strong></td>
										<td class="text-black">${{ subtotal }}</td>
									</tr>
									<tr>
										<td class="text-black font-weight-bold"><strong>Total de pedido</strong></td>
										<td class="text-black font-weight-bold" ><strong>${{ total }} / USD ${{total_dolar}}</strong></td>
									</tr>
								</tbody>
							</table>
				
							<div class="form-group">
								<a class="btn-lg py-3 btn-block" id="btnPaypal"></a>
							</div>
				
						</div>
					</div>
				</div>
		      </div>
		      <!-- </form> -->
		    </div>
		  </div>

{% endblock contenido %}
{% block js %}
<script src="https://www.paypalobjects.com/api/checkout.js"></script>
	<script>
		paypal.Button.render({
			env: 'sandbox',
			client: {
				sandbox: 'AUdczilLjDrMGcZtY3F9Xqa4WAmOmJQki8I3sWy9rTnnuxmiPWNOW1RACinASsIaWMDt8QPAbg0JQ1EL',
				production: 'demo_production_client_id'
			},
			locale: 'es_CL',
			style: {
				size: 'large',
				color: 'black',
				shape: 'rect'
			},
			commit: true,
			payment: function (data, actions) {
				return actions.payment.create({
					transactions: [{
						amount: { 
							total: '{{ total_dolar }}', 
							currency: 'USD'
						}
					}]
				});
			},
			onAuthorize: function (data, actions) {
                var csrftoken = getCookie('csrftoken');
                return actions.payment.execute().then(function () {
                    // Realizar una solicitud AJAX para crear la orden
                    $.ajaxSetup({
                        beforeSend: function(xhr, settings) {
                          xhr.setRequestHeader('X-CSRFToken', csrftoken);
                        }
                    });
                    $.ajax({
                        type: 'POST',
                        url: '/crear_orden/',  // Ruta de la vista para crear la orden
                        data: {},
                        success: function (response) {
                                // Orden creada correctamente
                                Swal.fire({
                                    title: '¡EL PAGO SE REALIZÓ CON ÉXITO!',
                                    text: 'Su número de orden es: ' + response.numero_orden,
                                    icon: 'success',
                                    showCancelButton: false,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Ver Boleta'
                                }).then(function () {
                                    // Redirigir a la página de la orden creada
                                    window.location.href = '/boleta/' + response.numero_orden;
                                });
                        },
                        error: function (xhr, textStatus, errorThrown) {
                            // Error en la solicitud AJAX
                            console.error(errorThrown)
                            Swal.fire({
                                title: 'Error',
                                text: 'ERROR EN LA SOLICITUD!',
                                icon: 'error',
                                showCancelButton: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Confirmar'
                            });
                        }
                    });
                });
            },
            
			onCancel(data) {
				Swal.fire({
						title: '¡CANCELADO!',
						text: 'Transacción cancelada!',
						icon: 'error',
						showCancelButton: false,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Confirmar'
					})
			},
			onError(err) {
                console.error(err)
				Swal.fire({
						title: 'Error',
						text: 'Ha ocurrido un error con el pago',
						icon: 'error',
						showCancelButton: false,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Confirmar'
					})
			}

		}, '#btnPaypal');
	</script>
{% endblock %}